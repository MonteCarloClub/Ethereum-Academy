[TOC]

# Ghost协议

## 1 Ghost协议的背景

比特币和以太坊工作于网络应用层的共识协议，其底层（网络层）是一个P2P Overlay network（P2P覆盖网络），Overlay network本身传输的时间是比较长的，因为它的拓扑协议做flooding没有考虑实际的拓扑结构，所以发布一个区块后，区块在网络上传到其他节点需要十几秒的时间，因为挖矿是个概率过程，所以还是会有两个矿工同时获得记账权，同时发布区块，带来临时性分叉。

临时性分叉产生的单块被称为orphan block/stale block(孤儿块或陈旧块)。

![image-20211208135857421](11-29\image-20211208135857421.png)

对于BTC来说，十分钟的出块时间，足够让新发布的区块传播到网络其他节点。

对于以太坊来说，由于出块时间短，其他节点可能还没有收到矿工发布的区块，就已经挖出了同一高度的区块，这就造成了临时性分叉。在以太坊网络中，临时性分叉发生的几率在 6.3% 左右。

![image-20211208144423755](11-29\image-20211208144423755.png)

##### 如何解决临时性分叉？

BTC里只有在最长合法链的区块包含的出块奖励才是有用的，其他的出块奖励都是作废的，对于BTC来说，出现临时性分叉的可能性还不是很多，所以这么规定还是可以接受的。

但对于以太坊来说，如果也是这样，矿工挖到的区块很大概率是白挖了，因为作废了，尤其是对个体矿工。加上挖矿设备的专业化和大型矿池的出现，对于个体矿工来说越来越不公平。矿池的收益应该是和所占的算力成比例的，比如算力是30%，收益也应该是30%，但是如果共识协议设置不好，大矿池的收益可能会大于30%。

![image-20211208135422620](11-29\image-20211208135422620.png)

比如刚出现分叉的时候，中间的5A区块是大矿池挖出的，剩下的5B、5C区块是个体矿工挖出的。大矿池肯定会沿着自己的区块接着往下挖，上下两个的区块只能希望别的矿工沿着自己的区块挖，但别的矿工更倾向于沿着中间的区块往下挖，造成矿池挖出的区块成为最长合法链的概率大于30%，mining centralization是占优势的。实际情况更糟，大型矿池的位置优势更明显，可能在网络中多个地方都有接口，大型矿池发布出的区块有可能更早的被其他节点收到。从历史经验来看，大型矿池所在的分叉更有可能成为最长合法链，因为沿着别的分叉挖，白挖的概率更大，所以越是大型的矿池收益越高，mining centralization越严重，也叫做centralization bias，中心化带来的不成比例的优势。

## 2 Ghost协议的内容

### 2.1 Ghost协议最初版本

Ghost（Greedy Heaviest Observed Subtree）协议，是由Yonatan Sompolinsky 和 Aviv Zohar在2013年12月引入的创新。

![image-20211208140105073](11-29\image-20211208140105073.png)

Ghost协议规定：每一个区块最多可以包含两个叔父区块，每个区块得到的奖励是2个以太币，叔父区块也是可以得到7/8的奖励（uncle reward），包含叔父区块的区块还可以额外获得1/32的奖励。

这样的设计就有利于分叉区块的合并，给分叉区块一些好处，使其加入到最长合法链，但是仍存在一些问题。

Q1：如果出现第三个叔父区块怎么办？

Q2：向下挖块之前没看到其中一个叔父区块，已经发布了下一个区块的时候才知道了那个叔父区块，那个叔父区块又变成没有奖励的区块，那怎么办呢？

Q3：矿池之间存在商业利益冲突，新区快故意不包含其中一个叔父区块，那怎么办呢？

### 2.2 Ghost协议更新版

##### 修改1：以太坊是没有“论资排辈”的，不论隔几代都可以作为叔父区块

Ghost协议规定：后面挖到的区块可以包含很早之前的叔父区块，不论是“爷爷辈”还是“曾祖父辈”。

![image-20211208140545762](11-29\image-20211208140545762.png)

这么规定就能解决之前的问题了。如果区块①不愿意包含叔父块，那么后面的区块②区块③可能会将其加入，因为最长链不一定都是一家矿池开采出来的。对于区块④（uncle block）因为超过了2个的上线，其在①块发布时未被认为叔父区块，但其后的区块②区块③会将其打包成为它们的叔父区块。

##### 修改2：叔父区块必须和当前区块在7代以内有共同祖先

![image-20211208141723876](11-29\image-20211208141723876.png)

Ghost协议规定：叔父区块必须和当前区块在7代以内有共同祖先才行，超过第7代就不能算作叔父区块了，所以一共有6个合法的辈分叔父区块。

**Q1：如果不设置7代会有什么问题？**

A：对于一个全节点来说，不设置辈分，它要维护的状态太多了，因为它可能需要记着隔100代以前有哪些叔父区块，发布的区块包含叔父区块都是要被其他节点验证的。

**Q2：但是挖下一个区块和叔父区块是不同的矿工，利益是不共通的，只是说对于叔父区块的矿工来说奖励最大，和区块本身利益影响不大，如何能做到尽早合并？**

A：因为叔父区块的奖励逐代递减，一出现分叉马上合并所能得到的出块奖励是最多的，这样就有利于鼓励出现分叉之后尽早合并。

## 3 以太坊的奖励部分

BTC：分为block reward/static reward 和 transaction reward。

ETH：分为block reward和gas fee。叔父区块得到的奖励只限于block reward，没有gas fee。以太坊的区块奖励是没有设置定期减半的。发布智能合约要支付gas fee，执行智能合约会得到gas fee。

**Q1：叔父区块包含的交易要不要执行？**

A：不应该执行，因为叔父区块包含的交易和主链的区块的交易可能是有冲突的，执行完主链区块的交易之后，叔父区块的交易可能是有冲突的，以太坊中，叔父区块的交易合法性是不会被检查的，只会查这个区块是不是符合挖矿难度要求的。

**Q2：叔父区块后面还跟着很多区块怎么办？这些区块都是叔父区块吗？第一个叔父区块后的区块还有奖励吗？**

A：如果将这些分叉区块都认为是叔父区块，每个都给奖励，那么整体合并形成分叉攻击的风险大大降低，因为即使未能攻击成功也能有一定的奖励。所以Ghost规定，只有分叉后的第一个区块可以得到叔父区块奖励，其他的都不能得到，这样一来也能鼓励合并，分叉后继续挖是徒劳的。

## 4.以太坊的真实情况

https://cn.etherscan.com/

![image-20211208131213536](11-29\image-20211208131213536.png)

![image-20211208131448754](11-29\image-20211208131448754.png)



## 5 相关源码

https://github.com/ethereum/go-ethereum/blob/master/consensus/ethash/consensus.go

```go
// Ethash proof-of-work protocol constants.
var (
	FrontierBlockReward           = big.NewInt(5e+18) // Block reward in wei for successfully mining a block
	ByzantiumBlockReward          = big.NewInt(3e+18) // Block reward in wei for successfully mining a block upward from Byzantium
	ConstantinopleBlockReward     = big.NewInt(2e+18) // Block reward in wei for successfully mining a block upward from Constantinople
	maxUncles                     = 2                 // Maximum number of uncles allowed in a single block
	allowedFutureBlockTimeSeconds = int64(15)         // Max seconds from current time allowed for blocks, before they're considered future blocks
```

- 起初每个区块有 5 个以太币的奖励；

- 在2017年10月16日（区块高度 4370000）执行拜占庭硬分叉，将奖励下降到 3 个以太币；
- 在2019年2月28日（区块高度 7280000）执行君士坦丁堡硬分叉，将奖励再次下降到 2 个以太币。
- 一次最多纳入主链的叔块数是2，出块时间是15秒